#Prepare Bloomberg Data for Factor Calculation given Security Universe
BBGData.Load <-
  function(Data.Name, Ref.Year)
  {
    savename <- paste(Data.Name, Ref.Year, sep = "")
    filename <- paste(savename, ".RData", sep = "")
    filepath <- paste("Data/", filename, sep = "")
    
    if(file.exists(filepath)){
      load(filepath)
    }else{
      #Call Read Function
      eval(parse(text = paste(savename,"=BBGData.Read.", Data.Name, "(Ref.Year)", sep = "")))
      #Save Data
      eval(parse(text = paste("save(",savename,",file='",filepath,"')", sep = "")))
    }
    eval(parse(text = paste("ret=",savename, sep = "")))
    return(ret)
  }

BBGData.Read.PX_LAST <-
  function(Ref.Year)
  {
    S.Date <- as.Date(paste(Ref.Year,"-01-01",sep = ""))
    E.Date <- as.Date(paste(Ref.Year,"-12-31",sep = ""))
    Options <- structure(c("NON_TRADING_WEEKDAYS","PREVIOUS_VALUE"), 
                         names = c("nonTradingDayFillOption","nonTradingDayFillMethod"))
    TEMP <- bdh(Universe$Ticker, "PX_LAST", start.date = S.Date, end.date = E.Date, options = Options)
    DATE <- bdh("SHSZ300 Index","PX_LAST", start.date = S.Date, end.date = E.Date, options = Options)$date
    PX_LAST <- cbind.data.frame(DATE,lapply(TEMP, (function(x) x$PX_LAST)))
    return(PX_LAST)
  }

BBGData.Read.BP_RATIO <-
  function(Ref.Year)
  {
    #Book to Price Ratio
    S.Date <- as.Date(paste(Ref.Year,"-01-01",sep = ""))
    E.Date <- as.Date(paste(Ref.Year,"-12-31",sep = ""))
    Options <- structure(c("NON_TRADING_WEEKDAYS","PREVIOUS_VALUE"), 
                         names = c("nonTradingDayFillOption","nonTradingDayFillMethod"))
    #Calendar Dates
    DATE <- bdh("SHSZ300 Index","PX_LAST", start.date = S.Date, end.date = E.Date, options = Options)$date
    PRICE <- bdh(Universe$Ticker, "PX_LAST", start.date = S.Date, end.date = E.Date, options = Options)
    PRICE <- lapply(PRICE, (function(x) x$PX_LAST[x$date %in% DATE]))[Universe$Ticker]
    BOOK <- bdh(Universe$Ticker, "BOOK_VAL_PER_SH", start.date = S.Date, end.date = E.Date, options = Options)
    BOOK <- lapply(BOOK, (function(x) x$BOOK_VAL_PER_SH[x$date %in% DATE]))[Universe$Ticker]
    
    BP_RATIO <- as.data.frame(BOOK)/as.data.frame(PRICE)
    names(BP_RATIO) <- Universe$Ticker
    BP_RATIO <- cbind.data.frame(DATE, BP_RATIO)
    
    return(BP_RATIO)
  }

BBGData.Read.EP_RATIO <-
  function(Ref.Year)
  {
    #Earnings to Price Ratio
    S.Date <- as.Date(paste(Ref.Year,"-01-01",sep = ""))
    E.Date <- as.Date(paste(Ref.Year,"-12-31",sep = ""))
    Options <- structure(c("NON_TRADING_WEEKDAYS","PREVIOUS_VALUE"), 
                         names = c("nonTradingDayFillOption","nonTradingDayFillMethod"))
    #Calendar Dates
    DATE <- bdh("SHSZ300 Index","PX_LAST", start.date = S.Date, end.date = E.Date, options = Options)$date
    PRICE <- bdh(Universe$Ticker, "PX_LAST", start.date = S.Date, end.date = E.Date, options = Options)
    PRICE <- lapply(PRICE, (function(x) x$PX_LAST[x$date %in% DATE]))[Universe$Ticker]
    EARNING <- bdh(Universe$Ticker, "TRAIL_12M_EPS_BEF_XO_ITEM", start.date = S.Date, end.date = E.Date, options = Options)
    EARNING <- lapply(EARNING, (function(x) x$TRAIL_12M_EPS_BEF_XO_ITEM[x$date %in% DATE]))[Universe$Ticker]
    
    EP_RATIO <- as.data.frame(EARNING)/as.data.frame(PRICE)
    names(EP_RATIO) <- Universe$Ticker
    EP_RATIO <- cbind.data.frame(DATE, EP_RATIO)
    
    return(EP_RATIO)
  }

BBGData.Read.CFP_RATIO <-
  function(Ref.Year)
  {
    #Cash Flow to Price Ratio
    S.Date <- as.Date(paste(Ref.Year,"-01-01",sep = ""))
    E.Date <- as.Date(paste(Ref.Year,"-12-31",sep = ""))
    Options <- structure(c("NON_TRADING_WEEKDAYS","PREVIOUS_VALUE"), 
                         names = c("nonTradingDayFillOption","nonTradingDayFillMethod"))
    #Calendar Dates
    DATE <- bdh("SHSZ300 Index","PX_LAST", start.date = S.Date, end.date = E.Date, options = Options)$date
    PRICE <- bdh(Universe$Ticker, "PX_LAST", start.date = S.Date, end.date = E.Date, options = Options)
    PRICE <- lapply(PRICE, (function(x) x$PX_LAST[x$date %in% DATE]))[Universe$Ticker]
    CF <- bdh(Universe$Ticker, "TRAIL_12M_CASH_FROM_OPER", start.date = S.Date, end.date = E.Date, options = Options)
    CF <- lapply(CF, (function(x) x$TRAIL_12M_CASH_FROM_OPER[x$date %in% DATE]))[Universe$Ticker]
    
    CFP_RATIO <- as.data.frame(CF)/as.data.frame(PRICE)
    names(CFP_RATIO) <- Universe$Ticker
    CFP_RATIO <- cbind.data.frame(DATE, CFP_RATIO)
    
    return(CFP_RATIO)
  }

BBGData.Read.EBITDA <-
  function(Ref.Year)
  {
    #EBITDA = Operating Income + Depreciation & Amortization (+ Interest Expense)
    OverRides <- structure(Ref.Year, names = "EQY_FUND_YEAR")
    EBITDA <- bdp(Universe$Ticker, "EBITDA", overrides = OverRides)
    OI <- bdp(Universe$Ticker, "IS_OPER_INC", overrides = OverRides)$IS_OPER_INC
    DA <- bdp(Universe$Ticker, "CF_DEPR_AMORT", overrides = OverRides)$CF_DEPR_AMORT
    IE <- bdp(Universe$Ticker, "IS_INT_EXPENSES", overrides = OverRides)$IS_INT_EXPENSES
    Indx1 <- is.na(EBITDA$EBITDA)
    Indx2 <- is.na(IE)
    EBITDA$EBITDA[Indx1&Indx2] <- OI[Indx1&Indx2] + DA[Indx1&Indx2]
    EBITDA$EBITDA[Indx1&!Indx2] <- OI[Indx1&!Indx2] + DA[Indx1&!Indx2] + IE[Indx1&!Indx2]
    return(EBITDA)
  }

BBGData.Road.EV <-
  function(Ref.Year)
  {
    #EV = Market Cap + LT Debt + max(ST Debt - Cash, 0)
    #Cash Flow to Price Ratio
    S.Date <- as.Date(paste(Ref.Year,"-01-01",sep = ""))
    E.Date <- as.Date(paste(Ref.Year,"-12-31",sep = ""))
    Options <- structure(c("NON_TRADING_WEEKDAYS","PREVIOUS_VALUE"), 
                         names = c("nonTradingDayFillOption","nonTradingDayFillMethod"))
    #Calendar Dates
    DATE <- bdh("SHSZ300 Index","PX_LAST", start.date = S.Date, end.date = E.Date, options = Options)$date
    fileds <- c("CUR_MKT_CAP","BS_LT_BORROW","BS_ST_BORROW","BS_CASH_NEAR_CASH_ITEM")
    TEMP <- bdh(Universe$Ticker, fileds, start.date = S.Date, end.date = E.Date, options = Options)
    TEMP <- lapply(TEMP, (function(x) x[x$date %in% DATE,]))[Universe$Ticker]
    EV <- cbind.data.frame(DATE,lapply(TEMP, (function(x) 
      x$CUR_MKT_CAP + x$BS_LT_BORROW + max(x$BS_ST_BORROW - x$BS_CASH_NEAR_CASH_ITEM, 0))))
    
    return(EV)
  }

BBGData.Initialize <-
  function(Universe)
  {
    
  }